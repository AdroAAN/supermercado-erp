{% extends "base.html" %}

{% block title %}Productos{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <!-- Barra superior con botones -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4 p-6
              bg-gradient-to-r from-blue-700 via-blue-600 to-blue-500
              rounded-2xl shadow-lg border border-blue-800 max-w-full overflow-hidden">
    <h1 class="text-3xl font-extrabold text-white tracking-tight flex items-center gap-2 select-none">
      <i data-lucide="package" class="w-8 h-8 stroke-white"></i>
      <span>Listado de Productos</span>
    </h1>

    <div class="flex flex-wrap gap-3 max-w-full min-w-0">
      <button id="btnCrearProducto"
        class="inline-flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold
              px-5 py-2 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-1
              flex-shrink-0 min-w-[130px]">
        <i data-lucide="plus-circle" class="w-5 h-5 stroke-white"></i>
        <span>Nuevo Producto</span>
      </button>

      <button id="btnCrearCategoria"
        class="inline-flex items-center gap-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold
              px-5 py-2 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1
              flex-shrink-0 min-w-[130px]">
        <i data-lucide="tag" class="w-5 h-5 stroke-white"></i>
        <span>Nueva Categoría</span>
      </button>
    </div>
  </div>
</div>

  <!-- Tabla de productos -->
  <div class="overflow-x-auto rounded-xl border border-gray-700 shadow-lg" style="max-width: 100%; position: relative;">
    <table id="tablaProductos" class="min-w-full divide-y divide-gray-700 text-white text-sm display" style="width:100%; min-width:600px; max-width: 100%; table-layout: auto;">
      <thead class="bg-gradient-to-r from-gray-900 to-gray-800 text-lime-300 uppercase text-xs font-semibold select-none">
        <tr>
          <th class="px-4 py-3 text-left whitespace-nowrap">Imagen</th>
          <th class="px-4 py-3 text-left whitespace-nowrap">Nombre</th>
          <th class="px-4 py-3 text-left whitespace-nowrap">Categoría</th>
          <th class="px-4 py-3 text-right whitespace-nowrap">Precio</th>
          <th class="px-4 py-3 text-center whitespace-nowrap">Stock</th>
          <th class="px-4 py-3 text-center whitespace-nowrap" style="width:150px;">Acciones</th>
        </tr>
      </thead>
      <tbody class="bg-gray-900 divide-y divide-gray-700">
        {% for producto in productos %}
        <tr class="transition-all duration-200 hover:bg-gray-800 cursor-pointer
          {% if forloop.counter0|divisibleby:2 %}bg-gray-800{% endif %}"
          data-descripcion="{{ producto.descripcion|default:'Sin descripción'|escapejs }}">
          <td class="px-4 py-3 text-center">
            {% if producto.imagen %}
              <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}"
                  width="50" height="50"
                  class="rounded-full cursor-pointer hover:opacity-80 transition mx-auto"
                  onclick="mostrarModalImagen('{{ producto.imagen.url }}')">
            {% else %}
              <div class="flex justify-center items-center bg-gray-700 rounded-full w-12 h-12 text-gray-400 font-bold">
                {{ producto.nombre|slice:":1"|upper }}
              </div>
            {% endif %}
          </td>
          <td class="px-4 py-3 whitespace-nowrap font-medium nombreProducto" title="{{ producto.descripcion|default:'Sin descripción' }}"> {{ producto.nombre }}</td>
          <td class="px-4 py-3 whitespace-nowrap">
            {% if producto.categoria %}
              <span class="inline-flex items-center gap-1">
                <i data-lucide="tag" class="w-4 h-4 text-blue-400"></i>
                {{ producto.categoria.nombre }}
              </span>
            {% else %}
              <span class="text-gray-400 italic">—</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-right font-semibold text-lime-400">${{ producto.precio|floatformat:2 }}</td>
          <td class="px-4 py-3 whitespace-nowrap text-center">
            <span class="inline-flex items-center gap-1 justify-center">
              {% if producto.stock > 10 %}
                <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
              {% elif producto.stock > 0 %}
                <i data-lucide="alert-circle" class="w-4 h-4 text-yellow-400"></i>
              {% else %}
                <i data-lucide="x-circle" class="w-4 h-4 text-red-400"></i>
              {% endif %}
              {{ producto.stock }}
            </span>
          </td>
          <td class="px-4 py-3 whitespace-normal flex flex-wrap gap-3 items-center justify-center">
            <button class="editarProductoBtn text-blue-400 hover:text-blue-300 flex items-center gap-1 font-medium transition-colors duration-200 flex-shrink-0 px-3 py-1 rounded-md hover:bg-blue-900/30"
                    data-id="{{ producto.id }}"
                    title="Editar producto"
                    aria-label="Editar producto">
              <i data-lucide="edit" class="w-4 h-4"></i>
              <span class="hidden md:inline">Editar</span>
            </button>
            <button class="eliminarProductoBtn text-red-500 hover:text-red-400 flex items-center gap-1 font-medium transition-colors duration-200 flex-shrink-0 px-3 py-1 rounded-md hover:bg-red-900/30"
                    data-id="{{ producto.id }}"
                    title="Eliminar producto"
                    aria-label="Eliminar producto">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
              <span class="hidden md:inline">Eliminar</span>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-6 py-8 text-center text-gray-500 italic font-semibold select-none">
            <div class="flex flex-col items-center justify-center gap-2">
              <i data-lucide="package-x" class="w-10 h-10 text-gray-400"></i>
              <span>No hay productos registrados</span>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modales de formulario: producto y categoría -->
<div id="modalProducto" class="modal hidden fixed inset-0 z-50 overflow-y-auto" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-overlay absolute inset-0 bg-black bg-opacity-50"></div>
  <div class="modal-content relative bg-soft rounded-lg shadow-xl w-full max-w-2xl mx-auto my-8 max-h-[90vh] overflow-y-auto p-6">
    <div id="modalProductoContent"></div>
  </div>
</div>

<div id="modalCategoria" class="modal hidden fixed inset-0 z-50 overflow-y-auto" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-overlay absolute inset-0 bg-black bg-opacity-50"></div>
  <div class="modal-content relative bg-soft rounded-lg shadow-xl w-full max-w-md mx-auto my-8 p-6">
    <form id="formCategoria" method="post">
      {% csrf_token %}
      <div class="border-b border-gray-600 pb-3 mb-4 flex items-center gap-3">
        <i data-lucide="tag" class="w-6 h-6 text-blue-400"></i>
        <h5 class="text-xl font-bold text-acento">Nueva categoría</h5>
      </div>
      <div class="space-y-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-2" for="catNombre">Nombre</label>
          <input type="text" id="catNombre" name="nombre" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2" for="catDesc">Descripción</label>
          <textarea id="catDesc" name="descripcion" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:ring-2 focus:ring-green-500 focus:border-transparent" rows="3"></textarea>
        </div>
        <div class="hidden bg-red-600 text-white p-3 rounded flex items-start gap-2" id="catError">
          <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0"></i>
          <span id="catErrorText"></span>
        </div>
      </div>
      <div class="flex justify-end gap-4">
        <button type="submit" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded transition flex items-center gap-2">
          <i data-lucide="save" class="w-4 h-4"></i> Guardar
        </button>
        <button type="button" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded transition flex items-center gap-2"
                onclick="ocultarModal('modalCategoria')">
          <i data-lucide="x" class="w-4 h-4"></i> Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function mostrarModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('overflow-hidden');
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);
    initLucideIcons();
}

function ocultarModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.opacity = '0';
    modal.setAttribute('aria-hidden', 'true');
    setTimeout(() => {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }, 200);
}

// Mostrar imagen con SweetAlert2
function mostrarModalImagen(imagenUrl) {
    Swal.fire({
        imageUrl: imagenUrl,
        imageAlt: 'Imagen producto',
        showCloseButton: true,
        showConfirmButton: false,
        background: '#111827',
        backdrop: 'rgba(0,0,0,0.8)',
        customClass: {
            popup: 'rounded-lg shadow-xl',
        }
    });
}

// Confirmar eliminación con SweetAlert2
function confirmarEliminar(id) {
    Swal.fire({
        title: '¿Estás seguro?',
        text: "Esta acción no se puede deshacer.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar',
        focusCancel: true,
        background: '#111827',
        customClass: {
            popup: 'rounded-lg shadow-xl text-white',
            title: 'text-yellow-400',
            cancelButton: 'bg-gray-600 hover:bg-gray-500',
            confirmButton: 'bg-red-600 hover:bg-red-500',
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            Swal.showLoading();

            $.post("{% url 'productos:eliminar' 0 %}".replace('0', id),
                {'csrfmiddlewaretoken': csrftoken},
                d => {
                    if (d.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Producto eliminado',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => location.reload());
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'No se pudo eliminar el producto.'
                        });
                    }
                }
            ).fail(() => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error inesperado al eliminar el producto.'
                });
            });
        }
    });
}

$(document).ready(function () {
    // Función para limpiar y formatear la descripción
    function limpiarDescripcion(desc) {
        if (!desc) return '';

        // Decodificar \u002D por guion normal
        desc = desc.replace(/\\u002D/g, '-');

        // Eliminar espacios y saltos al inicio y final
        desc = desc.trim();

        // Reemplazar saltos de línea reales y escapados por <br><br>
        desc = desc
            .replace(/\\u000D\\u000A/g, '<br><br>') // saltos escapados CRLF
            .replace(/\r\n/g, '<br><br>')           // saltos CRLF reales
            .replace(/\n/g, '<br><br>');             // saltos LF reales

        return desc;
    }

    // Inicializar DataTable
    $('#tablaProductos').DataTable({
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        pagingType: 'simple_numbers',
        stripeClasses: [],
        order: [[1, 'asc']],
        columnDefs: [
            { orderable: false, targets: [0, 5] }
        ],
        responsive: true,
        autoWidth: false,
        lengthMenu: [[5,10,25,50,-1],[5,10,25,50,"Todos"]],
        scrollX: true,
    });

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Función para mostrar error en modal producto
    function errorModalProd(msg) {
        $('#modalProductoContent .alert').remove();
        $('#modalProductoContent').prepend(
            `<div class="bg-red-600 text-white p-3 rounded mb-4 flex items-start gap-2">
                <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0"></i>
                <span>${msg}</span>
            </div>`);
        initLucideIcons();
    }

    // Cargar formulario producto
    function cargarFormularioProd(url) {
        $.get(url, data => {
            $('#modalProductoContent').html(data.html);
            mostrarModal('modalProducto');
            initLucideIcons();

            // Envío formulario producto
            $('#formProducto').on('submit', function(e) {
                e.preventDefault();
                const $btn = $(this).find('button[type="submit"]');
                const text = $btn.html();
                $btn.prop('disabled', true)
                    .html('<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Guardando…');

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: new FormData(this),
                    processData: false,
                    contentType: false,
                    headers: {'X-CSRFToken': csrftoken},
                    success: d => {
                        if (d.success) {
                            location.reload();
                        } else {
                            $('#modalProductoContent').html(d.html);
                            initLucideIcons();
                        }
                    },
                    error: () => errorModalProd('Error inesperado, inténtalo más tarde.'),
                    complete: () => {
                        $btn.prop('disabled', false).html(text);
                    }
                });
            });
        }).fail(() => errorModalProd('Error al cargar el formulario'));
    }

    // Eventos botones crear producto y categoría
    $('#btnCrearProducto').click(() => cargarFormularioProd("{% url 'productos:crear' %}"));

    $('#btnCrearCategoria').click(() => {
        $('#formCategoria')[0].reset();
        $('#catError').addClass('hidden');
        mostrarModal('modalCategoria');
    });

    // Editar producto
    $('#tablaProductos').on('click', '.editarProductoBtn', function(e) {
        e.stopPropagation(); // Prevenir abrir SweetAlert descripción
        cargarFormularioProd("{% url 'productos:editar' 0 %}".replace('0', $(this).data('id')));
    });

    // Eliminar producto
    $('#tablaProductos').on('click', '.eliminarProductoBtn', function(e) {
        e.stopPropagation(); // Prevenir abrir SweetAlert descripción
        const idDel = $(this).data('id');
        confirmarEliminar(idDel);
    });

    // Formulario categoría
    $('#formCategoria').on('submit', function(e) {
        e.preventDefault();
        const $f = $(this);
        const $btn = $f.find('button[type="submit"]');
        const txt = $btn.html();
        const $err = $('#catError').addClass('hidden');
        const $errText = $('#catErrorText').text('');

        $btn.prop('disabled', true).html('<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Guardando…');

        $.ajax({
            url: "{% url 'productos:crear_categoria' %}",
            type: 'POST',
            data: $f.serialize(),
            headers: {'X-CSRFToken': csrftoken},
            success: d => {
                if (d.success) {
                    ocultarModal('modalCategoria');
                    $f[0].reset();
                    location.reload();
                } else if (d.errors) {
                    $errText.text(d.errors.nombre || 'Error al guardar categoría.');
                    $err.removeClass('hidden');
                } else {
                    $errText.text('Error desconocido.');
                    $err.removeClass('hidden');
                }
            },
            error: () => {
                $errText.text('Error inesperado, inténtalo más tarde.');
                $err.removeClass('hidden');
            },
            complete: () => {
                $btn.prop('disabled', false).html(txt);
            }
        });
    });

    // Delegación evento click para botón crear categoría dentro del modal producto (botón estático en el form)
    $('#modalProductoContent').on('click', '#btnAddCat', function(e) {
        e.stopPropagation();
        mostrarModal('modalCategoria');
    });

    // Mostrar descripción al hacer click en fila excepto si se hizo click en imagen o botones editar/eliminar o btnAddCat
    $('#tablaProductos tbody').on('click', 'tr', function(e) {
      if (
          $(e.target).is('img') ||
          $(e.target).closest('.editarProductoBtn, .eliminarProductoBtn, #btnAddCat').length > 0
      ) return;

      const descripcion = $(this).data('descripcion') || 'Sin descripción disponible';
      const nombre = $(this).find('.nombreProducto').text().trim();

      // Usar la función limpiarDescripcion para formatear texto
      const descripcionFormateada = limpiarDescripcion(descripcion);

      Swal.fire({
          title: nombre,
          html: descripcionFormateada,
          icon: 'info',
          confirmButtonText: 'Cerrar',
          background: '#111827',
          color: '#d1fae5',
          customClass: {
              popup: 'rounded-lg shadow-xl',
              title: 'text-lime-400',
          },
          scrollbarPadding: false
      });
  });
});
</script>
{% endblock %}
